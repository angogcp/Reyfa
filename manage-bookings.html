<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Bookings - CleanFast</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Inter', sans-serif; font-weight: 700; }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <img src="resources/logo.png" alt="CleanFast Logo" class="h-8 w-auto">
                    <h1 class="ml-3 font-bold text-xl text-teal-600">CleanFast Admin</h1>
                </div>
                <nav class="flex space-x-4">
                    <a href="admin.html" class="text-slate-600 hover:text-teal-600">Dashboard</a>
                    <a href="manage-bookings.html" class="text-teal-600 font-medium">Bookings</a>
                    <!-- Add more nav items as needed -->
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Manage Bookings</h2>
                <button id="refreshBookings" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">Refresh</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Service</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable" class="bg-white divide-y divide-slate-200">
                        <!-- Bookings will be populated here via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="./resources/api-utils.js"></script>
    <script src="main.js"></script>
    <script>
        // Require admin login
        if (!localStorage.getItem('loggedIn') || localStorage.getItem('userRole') !== 'admin') {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const bookingsTable = document.getElementById('bookingsTable');
            const refreshButton = document.getElementById('refreshBookings');
            
            async function fetchBookings() {
                try {
                    // Use API utilities to get the correct URL for the current environment
                    const response = await fetch(window.apiUtils.createApiUrl('/bookings'));
                    if (!response.ok) throw new Error('Failed to fetch bookings');
                    const bookings = await response.json();
                    renderBookings(bookings);
                } catch (error) {
                    console.error('Error fetching bookings:', error);
                    bookingsTable.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-600">Error loading bookings</td></tr>';
                }
            }
            
            function renderBookings(bookings) {
                bookingsTable.innerHTML = '';
                bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4">${booking.fullName || '-'}</td>
                        <td class="px-6 py-4">${booking.serviceType || '-'}</td>
                        <td class="px-6 py-4">${booking.bookingDate || '-'} ${booking.bookingTime || ''}</td>
                        <td class="px-6 py-4 capitalize">${booking.status || '-'}</td>
                        <td class="px-6 py-4">RM ${booking.estimatedPrice ?? '-'}</td>
                        <td class="px-6 py-4 space-x-2">
                            <button class="px-3 py-1 rounded bg-teal-500 text-white hover:bg-teal-600" onclick="updateStatus('${booking.id}','accepted')">Accept</button>
                            <button class="px-3 py-1 rounded bg-slate-700 text-white hover:bg-slate-800" onclick="updateStatus('${booking.id}','completed')">Complete</button>
                            <a class="px-3 py-1 rounded bg-green-500 text-white hover:bg-green-600" href="https://wa.me/6${booking.phoneNumber}" target="_blank">WhatsApp</a>
                            <a class="px-3 py-1 rounded bg-orange-500 text-white hover:bg-orange-600" href="tel:${booking.phoneNumber}">Call</a>
                        </td>
                    `;
                    bookingsTable.appendChild(row);
                });
            }

            refreshButton?.addEventListener('click', fetchBookings);
            fetchBookings();
        });

        async function updateStatus(id, status) {
            try {
                const resp = await fetch(window.apiUtils.createApiUrl(`/bookings/${id}`), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (!resp.ok) throw new Error('Failed to update status');
                alert(`Status updated to ${status}`);
                // Reload bookings to reflect changes
                const refreshButton = document.getElementById('refreshBookings');
                refreshButton?.click();
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Error updating status');
            }
        }
    </script>
</body>
</html>