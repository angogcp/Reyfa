<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Bookings - CleanFast</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-display { font-family: 'Inter', sans-serif; font-weight: 700; }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <img src="resources/logo.png" alt="CleanFast Logo" class="h-8 w-auto">
                    <h1 class="ml-3 font-bold text-xl text-teal-600">CleanFast Admin</h1>
                </div>
                <nav class="flex space-x-4">
                    <a href="admin.html" class="text-slate-600 hover:text-teal-600">Dashboard</a>
                    <a href="manage-bookings.html" class="text-teal-600 font-medium">Bookings</a>
                    <!-- Add more nav items as needed -->
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Manage Bookings</h2>
                <button id="refreshBookings" class="bg-teal-600 text-white px-4 py-2 rounded hover:bg-teal-700">Refresh</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Service</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable" class="bg-white divide-y divide-slate-200">
                        <!-- Bookings will be populated here via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bookingsTable = document.getElementById('bookingsTable');
            const refreshButton = document.getElementById('refreshBookings');
            
            async function fetchBookings() {
                try {
                    // Use API utilities to get the correct URL for the current environment
                    const apiUrl = window.apiUtils ? 
                        window.apiUtils.createApiUrl('/bookings') : 
                        (window.location.hostname.includes('vercel.app') ? '/api/bookings' : '/bookings');
                    
                    const response = await fetch(window.apiUtils.createApiUrl(apiUrl));
                    if (!response.ok) throw new Error('Failed to fetch bookings');
                    const bookings = await response.json();
                    renderBookings(bookings);
                } catch (error) {
                    console.error('Error fetching bookings:', error);
                    bookingsTable.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-600">Error loading bookings</td></tr>';
                }
            }
            
            function renderBookings(bookings) {
                bookingsTable.innerHTML = '';
                bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.id || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.fullName} (${booking.phoneNumber})</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.serviceType}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${booking.bookingDate} - ${booking.bookingTime}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${
                                booking.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                booking.status === 'accepted' ? 'bg-blue-100 text-blue-800' :
                                booking.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
                            }">${booking.status || 'pending'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                            ${booking.status === 'pending' ? '<button class="accept-btn bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 mr-2" data-id="' + booking.id + '">Accept</button>' : ''}
                            ${booking.status !== 'completed' ? '<button class="complete-btn bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700" data-id="' + booking.id + '">Complete</button>' : ''}
                        </td>
                    `;
                    bookingsTable.appendChild(row);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.accept-btn').forEach(btn => {
                    btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'accepted'));
                });
                document.querySelectorAll('.complete-btn').forEach(btn => {
                    btn.addEventListener('click', () => updateStatus(btn.dataset.id, 'completed'));
                });
            }
            
            async function updateStatus(id, status) {
                try {
                    const response = await fetch(window.apiUtils.createApiUrl(`/api/bookings/${id}`), {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    if (!response.ok) throw new Error('Failed to update status');
                    fetchBookings(); // Refresh the list
                } catch (error) {
                    console.error('Error updating status:', error);
                    alert('Failed to update booking status');
                }
            }
            
            refreshButton.addEventListener('click', fetchBookings);
            fetchBookings(); // Initial load
        });
    </script>
</body>
</html>